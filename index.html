<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sadoitor</title>
<meta name="color-scheme" content="light">
<style>
:root{
  --brand:#04A443; --accent:#F3C432;
  --page:#F6F8FA; --panel:#fff; --text:#0F172A; --muted:#667085; --line:#E9EEF0;
  --radius:18px; --shadow:0 12px 32px rgba(15,23,42,.08), 0 2px 10px rgba(15,23,42,.04);
  --ring:rgba(4,164,67,.3);

  /* единая сетка */
  --wrap:1100px;   /* максимальная ширина контейнеров */
  --gutter:14px;   /* внутренние отступы по бокам */
}
*{box-sizing:border-box}
body{margin:0;background:var(--page);color:var(--text);font:16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* ========= HEADER ========= */
.appbar{position:sticky;top:0;z-index:50;background:#000;border-bottom:1px solid #121212}
.appbar .in{max-width:var(--wrap);margin:0 auto;padding:12px var(--gutter);display:flex;align-items:center;gap:14px}
.logo{width:34px;height:34px;border-radius:10px;overflow:hidden;background:#0f0f0f;flex:0 0 auto}
.logo img{width:100%;height:100%;object-fit:contain}
.brand{color:#fff;font-weight:900;letter-spacing:.2px}
.nav{margin-left:auto;display:flex;gap:22px}
.nav a{display:inline-block;color:#fff;text-decoration:none;font-weight:800;opacity:.7;padding:10px 6px;position:relative}
.nav a.active,.nav a:hover{opacity:1}
/* подчёркивание строго по центру ссылки */
.nav a.active::after{
  content:""; position:absolute; bottom:-6px; left:50%;
  transform:translateX(-50%);
  width:60%; height:3px; border-radius:3px; background:#fff;
}

/* ========= LAYOUT ========= */
.container{max-width:var(--wrap);margin:18px auto;padding:0 var(--gutter)}
.card{background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow)}
.header{display:flex;align-items:center;gap:14px;padding:18px 18px 0}
.header h1{margin:0;font-size:26px}
.searchRow{display:flex;gap:10px;align-items:center;padding:12px 18px 18px}
.search{flex:1;border:1px solid var(--line);background:#fff;border-radius:999px;padding:12px 16px}
.list{padding:0 18px 18px}
.item{display:flex;align-items:center;gap:8px;padding:14px 0;border-bottom:1px solid var(--line);cursor:pointer}
.item:last-child{border-bottom:none}
.itext{flex:1}
.ititle{font-weight:800}
.isub{color:#9AA4B2}
.iact{color:#7A8595;font-weight:700;cursor:pointer}

/* ========= BOTTOM ACTION ========= */
.bottomBar{position:sticky;bottom:0;z-index:40}
.bottomInner{max-width:var(--wrap);margin:0 auto;padding:0 var(--gutter)}
.bigbtn{display:block;width:100%;background:var(--brand);color:#fff;border:none;border-radius:16px;padding:16px 18px;font-weight:900;box-shadow:0 16px 38px rgba(4,164,67,.25);margin:12px 0}
.bigbtn:active{transform:translateY(1px)}

/* ========= DIALOGS ========= */
dialog{border:none;border-radius:22px;width:min(880px,96vw);padding:0;box-shadow:0 28px 70px rgba(2,8,23,.45)}
dialog::backdrop{background:rgba(2,8,23,.5);backdrop-filter:blur(2px)}
.dhead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:#fff;border-top-left-radius:22px;border-top-right-radius:22px}
.dbody{padding:14px;background:#fff;border-bottom-left-radius:22px;border-bottom-right-radius:22px}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.field input,.field textarea,.field select{border:1px solid var(--line);border-radius:12px;padding:12px 12px;background:#fff;outline:none}
.field input:focus,.field textarea:focus,.field select:focus{box-shadow:0 0 0 4px var(--ring)}
.row{display:grid;gap:10px}
@media(min-width:680px){ .row{grid-template-columns:1fr 1fr} }
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700}
.btn-primary{background:var(--brand);border:none;color:#fff}
.btn-accent{background:var(--accent);border:none;color:#2b2000}

/* ========= SONG PAGE ========= */
.songCard{background:#fff;border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:18px}
.shead{display:flex;align-items:center;justify-content:space-between}
.smeta{color:#7a8595;font-weight:700}
.bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:14px 0}
.ghost{background:#fff;border:1px solid var(--line);border-radius:12px;padding:8px 12px}
select{border:1px solid var(--line);border-radius:12px;background:#fff;padding:8px 12px;min-width:120px}
.lyrics{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
.line{display:block;margin:2px 0}
.cw{display:inline-grid;grid-template-rows:auto 1.25em;align-items:end;min-width:.25em;margin-right:.03em}
.cw .ch{font-weight:800;font-size:.86em;line-height:1;color:#0A6A7A}
.cw .tx{line-height:1.25}

/* ========= LOADERS / TOAST ========= */
.overlay{position:fixed;inset:0;background:rgba(255,255,255,.45);backdrop-filter:blur(1.6px);display:none;align-items:center;justify-content:center;z-index:60}
.spinner{width:54px;height:54px;border:6px solid #e9eef0;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;left:50%;transform:translateX(-50%);top:14px;z-index:70;display:none}
.toast .msg{background:#0b0b0b;color:#fff;border:1px solid #222;padding:12px 16px;border-radius:12px;box-shadow:0 16px 45px rgba(0,0,0,.35)}

/* ========= FOOTER ========= */
.footer{background:transparent}
.footer .in{max-width:var(--wrap);margin:24px auto 28px;padding:0 var(--gutter);color:#7a8595;font-size:13px}
</style>
</head>
<body>

<!-- HEADER -->
<div class="appbar">
  <div class="in">
    <div class="logo"><img src="https://i.postimg.cc/NFrYFn0x/112.png" alt=""></div>
    <div class="brand">Sadoitor</div>
    <nav class="nav">
      <a href="#/artists" id="nav-artists">Исполнители</a>
      <a href="#/songs"   id="nav-songs">Песни</a>
    </nav>
  </div>
</div>

<div id="app" class="container"></div>

<!-- bottom action bar -->
<div class="bottomBar"><div class="bottomInner"><div id="bigAction"></div></div></div>

<footer class="footer">
  <div class="in">© <span id="year"></span> Sadoitor • Сделано с любовью к музыке</div>
</footer>

<!-- Overlay/Toast -->
<div id="overlay" class="overlay"><div class="spinner"></div></div>
<div id="toast" class="toast"><div class="msg" id="toastMsg"></div></div>

<!-- Modals -->
<dialog id="artistModal">
  <div class="dhead"><strong id="artistModalTitle">Исполнитель</strong><button id="closeArtistModal" class="btn">✕</button></div>
  <div class="dbody">
    <input type="hidden" id="aId">
    <div class="field"><label>Имя</label><input id="aName" placeholder="Напр.: Далер"></div>
    <div style="display:flex;gap:10px;justify-content:end">
      <button id="saveArtist" class="btn btn-accent"><span class="btnText">Сохранить</span></button>
    </div>
  </div>
</dialog>

<dialog id="songModal">
  <div class="dhead"><strong id="songModalTitle">Песня</strong><button id="closeSongModal" class="btn">✕</button></div>
  <div class="dbody">
    <input type="hidden" id="sId">
    <div class="row">
      <div class="field"><label>Название</label><input id="sTitle" placeholder="Напр.: Сабза ба ноз"></div>
      <div class="field"><label>Исполнитель</label><select id="sArtistSel"></select></div>
    </div>
    <div class="field"><label>Текст (ChordPro)</label><textarea id="sText" placeholder="[Am]пример строки"></textarea></div>
    <div style="display:flex;gap:10px;justify-content:end">
      <button id="saveSong" class="btn btn-primary"><span class="btnText">Сохранить</span></button>
    </div>
  </div>
</dialog>

<script>
/* CONFIG */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx3u6Rheu-rtntNEN8Hs491fhEoksqinhvP1dE-83-KUK8NgtKVM_KxXK5HwHs7c8oUxA/exec';

/* HELPERS */
const $ = s => document.querySelector(s);
const app = $('#app'), bigAction = $('#bigAction');
$('#year').textContent = new Date().getFullYear();
function showOverlay(v=true){ $('#overlay').style.display = v?'flex':'none'; }
function toast(msg, ms=2200){ $('#toastMsg').textContent = msg; $('#toast').style.display='block'; setTimeout(()=>$('#toast').style.display='none', ms); }

/* API */
async function api(action, payload = {}) {
  const isGet = action === 'catalog' || action === 'lists';
  const qp = action === 'catalog' ? '?action=catalog' : action === 'lists' ? '?action=lists' : '';
  const res = await fetch(WEB_APP_URL + qp, {
    method: isGet ? 'GET' : 'POST',
    headers: isGet ? {} : { 'Content-Type':'text/plain;charset=utf-8' },
    body: isGet ? undefined : JSON.stringify({ action, ...payload })
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { throw new Error(text || 'Server returned non-JSON'); }
}

/* STATE */
let artists = [];
let songs = [];

/* CHORDS + render */
const SHARP=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT =['C','Db','D','Eb','E','F','Gb','G','Ab','A','Bb','B'];
const useSharp = ch=>/#/.test(ch);
function tChord(ch,steps){const m=ch.match(/^([A-G](?:#|b)?)(.*)$/); if(!m) return ch; const root=m[1], rest=m[2]||''; const seq=useSharp(root)?SHARP:FLAT; let i=SHARP.indexOf(root); if(i<0) i=FLAT.indexOf(root); if(i<0) return ch; let ni=(i+steps)%12; if(ni<0) ni+=12; let out=seq[ni]; const sl=rest.match(/^(.*?)(\/)([A-G](?:#|b)?)$/); if(sl){ let bi=SHARP.indexOf(sl[3]); if(bi<0) bi=FLAT.indexOf(sl[3]); if(bi>=0){ let bni=(bi+steps)%12; if(bni<0) bni+=12; return out+sl[1]+sl[2]+seq[bni]; } } return out+rest; }
function tText(txt,steps){ return (txt||'').replace(/\[([^\]]+)\]/g,(_,c)=>`[${tChord(c.trim(),steps)}]`) }
function parseChordPro(text){
  const lines=(text||'').split(/\r?\n/); const out=[];
  for(const line of lines){
    if(!line.trim()){ out.push('<br>'); continue; }
    const parts=line.split(/(\[[^\]]+\])/g); let pending=null; let html='<span class="line">';
    for(const part of parts){
      if(!part) continue;
      if(part.startsWith('[')&&part.endsWith(']')) pending=part.slice(1,-1).trim();
      else{
        if(pending){ html+=`<span class="cw"><span class="ch">${pending}</span><span class="tx">${part}</span></span>`; pending=null; }
        else html+=`<span class="cw"><span class="ch"></span><span class="tx">${part}</span></span>`;
      }
    }
    if(pending){ html+=`<span class="cw"><span class="ch">${pending}</span><span class="tx">&nbsp;</span></span>`; }
    out.push(html+'</span>');
  }
  return out.join('\n').replaceAll('<span class="tx"></span>','<span class="tx">&nbsp;</span>');
}

/* DATA */
async function loadAll(){
  const lists = await api('lists');
  artists = lists.artists||[];
  songs   = lists.songs||[];
}

/* ROUTER */
window.addEventListener('hashchange', route);
async function route(){
  const hash = location.hash || '#/artists';
  $('#nav-artists').classList.toggle('active', hash.startsWith('#/artists'));
  $('#nav-songs').classList.toggle('active',   hash.startsWith('#/songs') || hash.startsWith('#/song/'));

  showOverlay(true);
  try{
    if(!artists.length && !songs.length) await loadAll();

    if(hash.startsWith('#/artists')) renderArtists();
    else if(hash.startsWith('#/songs')) renderSongs();
    else if(hash.startsWith('#/song/')) renderSongPage(hash.split('/')[2]);
    else location.hash = '#/artists';
  } finally {
    showOverlay(false);
  }
}

/* PAGES */
function renderArtists(){
  const page = document.createElement('div');
  page.className='card';
  page.innerHTML = `
    <div class="header"><h1>Исполнители</h1></div>
    <div class="searchRow"><input id="searchArtists" class="search" placeholder="Поиск"></div>
    <div id="alist" class="list"></div>
  `;
  app.innerHTML=''; app.appendChild(page);

  const alist = page.querySelector('#alist');
  alist.innerHTML = artists.map(a=>`
    <div class="item" data-id="${a.id}">
      <div class="itext">
        <div class="ititle">${escapeHtml(a.name||'')}</div>
        <div class="isub">Исполнитель</div>
      </div>
      <div class="iact" data-edit="${a.id}">Изменить</div>
    </div>`).join('');

  // клик по строке -> на страницы песен с фильтром по артисту
  alist.querySelectorAll('.item').forEach(el=>{
    el.addEventListener('click', (e)=>{
      if(e.target.closest('.iact')) return;
      location.hash = `#/songs?artist=${encodeURIComponent(el.dataset.id)}`;
    });
  });
  alist.querySelectorAll('[data-edit]').forEach(x=>x.onclick=(ev)=>{ ev.stopPropagation(); openArtistEdit(x.dataset.edit); });

  const qEl = page.querySelector('#searchArtists');
  qEl.oninput = ()=>{
    const q=(qEl.value||'').toLowerCase().trim();
    [...alist.children].forEach(row=>{
      const a = artists.find(x=>x.id==row.dataset.id);
      row.style.display = (!q || a.name.toLowerCase().includes(q)) ? '' : 'none';
    });
  };

  bigAction.innerHTML = `<button class="bigbtn" id="addArtistBig">Добавить исполнителя</button>`;
  $('#addArtistBig').onclick = openArtistAdd;
}

function renderSongs(){
  const qHash = location.hash.split('?')[1] || '';
  const params = new URLSearchParams(qHash);
  const artistId = params.get('artist');

  const page = document.createElement('div');
  page.className='card';
  page.innerHTML = `
    <div class="header"><h1>Песни</h1></div>
    <div class="searchRow"><input id="searchSongs" class="search" placeholder="Поиск"></div>
    <div id="slist" class="list"></div>
  `;
  app.innerHTML=''; app.appendChild(page);

  const slist = page.querySelector('#slist');
  const qEl = page.querySelector('#searchSongs');

  if(artistId){
    const a = artists.find(x=>String(x.id)===String(artistId));
    if(a){ qEl.value = a.name; }
  }

  const render = ()=>{
    const q=(qEl.value||'').toLowerCase().trim();
    const data = songs.filter(s=>{
      const a = artists.find(x=>x.id==s.artistId);
      const inArtist = a && a.name.toLowerCase().includes(q);
      const inTitle  = s.title.toLowerCase().includes(q);
      return !q || inArtist || inTitle;
    });
    slist.innerHTML = data.map(s=>{
      const a = artists.find(x=>x.id==s.artistId);
      return `
        <div class="item" data-song="${s.id}">
          <div class="itext">
            <div class="ititle"><a style="text-decoration:none;color:inherit" href="#/song/${s.id}">${escapeHtml(s.title)}</a></div>
            <div class="isub">${escapeHtml(a?.name||'—')}</div>
          </div>
          <div class="iact" data-edit="${s.id}">Изменить</div>
        </div>`;
    }).join('');
    slist.querySelectorAll('[data-edit]').forEach(x=>x.onclick=(ev)=>{ ev.stopPropagation(); openSongEdit(x.dataset.edit); });
  };
  render();
  qEl.oninput = render;

  bigAction.innerHTML = `<button class="bigbtn" id="addSongBig">Добавить текст песни</button>`;
  $('#addSongBig').onclick = openSongAdd;
}

function renderSongPage(songId){
  const s = songs.find(x=>String(x.id)===String(songId));
  if(!s){ app.innerHTML = `<div class="isub">Песня не найдена</div>`; bigAction.innerHTML=''; return; }
  const a = artists.find(x=>String(x.id)===String(s.artistId));
  app.innerHTML = `
    <div class="songCard">
      <div class="shead">
        <div>
          <div style="font-weight:900;font-size:22px">${escapeHtml(s.title)}</div>
          <div class="smeta">${escapeHtml(a?.name||'—')}</div>
        </div>
        <a class="btn" href="#/songs">✕</a>
      </div>

      <div class="bar">
        <button id="scrollToggle" class="btn btn-accent">Авто-прокрутка ▷</button>
        <label style="color:var(--muted)">Скорость <input id="scrollSpeed" type="range" min="10" max="120" value="50" style="vertical-align:middle"></label>
        <button id="tDown" class="ghost">Трансп. −</button>
        <button id="tUp"   class="ghost">Трансп. +</button>
        <select id="fontSel">
          <option value="15">Шрифт 15</option>
          <option value="16" selected>Шрифт 16</option>
          <option value="18">Шрифт 18</option>
          <option value="20">Шрифт 20</option>
          <option value="22">Шрифт 22</option>
        </select>
      </div>

      <div id="lyrics" class="lyrics"></div>
    </div>
  `;
  bigAction.innerHTML = '';

  let current = {...s};
  const lyricsEl = $('#lyrics');
  const fontSel = $('#fontSel');
  function renderLyrics(){ lyricsEl.style.fontSize=(fontSel.value||16)+'px'; lyricsEl.innerHTML = parseChordPro(current.text||''); }
  renderLyrics();
  $('#tDown').onclick=()=>{ current.text=tText(current.text,-1); if(current.key) current.key=tChord(current.key,-1); renderLyrics(); };
  $('#tUp').onclick  =()=>{ current.text=tText(current.text, 1); if(current.key) current.key=tChord(current.key, 1); renderLyrics(); };

  let scrollTimer=null;
  $('#scrollToggle').onclick=()=>{ if(scrollTimer){ stop(); } else start(); };
  function start(){ if(scrollTimer) return; $('#scrollToggle').textContent='Авто-прокрутка ❚❚';
    const step=()=>{ window.scrollBy(0, Number($('#scrollSpeed').value||50)/33.3); scrollTimer=requestAnimationFrame(step); };
    scrollTimer=requestAnimationFrame(step);
  }
  function stop(){ $('#scrollToggle').textContent='Авто-прокрутка ▷'; if(scrollTimer){ cancelAnimationFrame(scrollTimer); scrollTimer=null; } }
  fontSel.onchange=renderLyrics;
}

/* ESC HTML */
function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }

/* MODALS */
function openArtistAdd(){ openArtistModal(); }
function openArtistEdit(id){ const a=artists.find(x=>x.id==id); if(!a) return; openArtistModal(a); }
function openArtistModal(a=null){
  $('#artistModalTitle').textContent = a? 'Изменить исполнителя' : 'Добавить исполнителя';
  $('#aId').value = a?.id || '';
  $('#aName').value = a?.name || '';
  $('#artistModal').showModal();
}
function openSongAdd(){ openSongModal(); }
function openSongEdit(id){ const s=songs.find(x=>x.id==id); if(!s) return; openSongModal(s); }
function refreshArtistSelect(){
  $('#sArtistSel').innerHTML = `<option value="">— без привязки —</option>` + artists.map(a=>`<option value="${a.id}">${escapeHtml(a.name)}</option>`).join('');
}
function openSongModal(s=null){
  $('#songModalTitle').textContent = s? 'Изменить песню' : 'Добавить песню';
  $('#sId').value = s?.id || '';
  $('#sTitle').value = s?.title || '';
  refreshArtistSelect();
  $('#sArtistSel').value = s?.artistId || '';
  $('#sText').value = s?.text || '';
  $('#songModal').showModal();
}

/* SAVE */
function withBtnSpinner(btn, fn){
  const t = btn.querySelector('.btnText'); const old = t.textContent; t.textContent='Сохранение…'; btn.disabled=true;
  return fn().finally(()=>{ t.textContent=old; btn.disabled=false; });
}
$('#saveArtist').onclick = ()=> withBtnSpinner($('#saveArtist'), async ()=>{
  const id = $('#aId').value || undefined;
  const name = $('#aName').value.trim(); if(!name){ toast('Имя исполнителя обязательно'); return; }
  showOverlay(true);
  try{
    const r = await api('upsertArtist', { id, name });
    if(!r.ok) throw new Error(r.error||'Ошибка сохранения');
    $('#artistModal').close();
    artists = []; songs = [];
    await loadAll(); toast(id? 'Изменения сохранены' : 'Исполнитель добавлен'); route();
  }catch(e){ toast('Ошибка: '+e.message, 3500); }
  finally{ showOverlay(false); }
});
$('#saveSong').onclick = ()=> withBtnSpinner($('#saveSong'), async ()=>{
  const id = $('#sId').value || undefined;
  const title = $('#sTitle').value.trim(); if(!title){ toast('Название песни обязательно'); return; }
  const payload = { id, title, artistId: $('#sArtistSel').value || '', text: $('#sText').value.replace(/\r\n/g,'\n') };
  showOverlay(true);
  try{
    const r = await api('upsertSong', payload);
    if(!r.ok) throw new Error(r.error||'Ошибка сохранения');
    $('#songModal').close();
    artists = []; songs = [];
    await loadAll(); toast(id? 'Изменения сохранены' : 'Песня добавлена'); route();
  }catch(e){ toast('Ошибка: '+e.message, 3500); }
  finally{ showOverlay(false); }
});
$('#closeArtistModal').onclick = ()=>$('#artistModal').close();
$('#closeSongModal').onclick   = ()=>$('#songModal').close();

/* INIT */
(async function init(){
  try{ showOverlay(true); await loadAll(); route(); }
  catch(e){ toast('Ошибка загрузки: '+e.message, 3500); }
  finally{ showOverlay(false); }
})();
</script>
</body>
</html>
